/*
 GPS.js v0.3.0 26/01/2016

 Copyright (c) 2016, Robert Eisele (robert@xarg.org)
 Dual licensed under the MIT or GPL Version 2 licenses.
*/
(function(t){function l(b,a){if(""===b)return null;var c=new Date;if(a){var d=a.slice(4),e=a.slice(2,4)-1,f=a.slice(0,2);4===d.length?c.setUTCFullYear(d,e,f):c.setUTCFullYear("20"+d,e,f)}c.setUTCHours(b.slice(0,2));c.setUTCMinutes(b.slice(2,4));c.setUTCSeconds(b.slice(4,6));d=b.slice(7);e=d.length;f=0;0!==e&&(f=parseFloat(d)*Math.pow(10,3-e));c.setUTCMilliseconds(f);return c}function k(b,a){if(""===b)return null;var c=1;switch(a){case "S":c=-1;case "N":var d=2;break;case "W":c=-1;case "E":d=3}return c*
(parseFloat(b.slice(0,d))+parseFloat(b.slice(d))/60)}function f(b){return""===b?null:parseFloat(b)}function n(b){return""===b?null:1.852*parseFloat(b)}function u(b){switch(b){case "":case "0":return null;case "1":return"fix";case "2":return"dgps-fix";case "3":return"pps-fix";case "4":return"rtk";case "5":return"rtk-float";case "6":return"estimated";case "7":return"manual";case "8":return"simulated"}throw"INVALID GGA FIX: "+b;}function p(b){switch(b){case "A":return"active";case "V":return"void";case "":return null}throw"INVALID RMC/GLL STATUS: "+
b;}function q(b){switch(b){case "A":return"autonomous";case "D":return"differential";case "E":return"estimated";case "M":return"manual input";case "S":return"simulated";case "N":return"not valid";case "P":return"precise"}throw"INVALID FAA MODE: "+b;}function r(b,a){if("M"===a||""===a)return f(b);throw"Unknown unit: "+a;}function g(){this.events={};this.state={}}var h=Math.PI/180,v=180/Math.PI,m=[];g.prototype.events=null;g.prototype.state=null;g.mod={GGA:function(b,a){if(16!==a.length)throw"Invalid GGA length: "+
b;return{time:l(a[1]),lat:k(a[2],a[3]),lon:k(a[4],a[5]),alt:r(a[9],a[10]),quality:u(a[6]),satelites:f(a[7]),hdop:f(a[8]),geoidal:r(a[11],a[12]),age:f(a[13]),stationID:f(a[14])}},GSA:function(b,a){if(19!==a.length)throw"Invalid GSA length: "+b;for(var c=[],d=3;15>d;d++)""!==a[d]&&c.push(parseInt(a[d],10));a:{d=a[1];switch(d){case "M":d="manual";break a;case "A":d="automatic";break a;case "":d=null;break a}throw"INVALID GSA MODE: "+d;}a:{var e=a[2];switch(e){case "1":case "":e=null;break a;case "2":e=
"2D";break a;case "3":e="3D";break a}throw"INVALID GSA FIX: "+e;}return{mode:d,fix:e,satellites:c,pdop:f(a[15]),hdop:f(a[16]),vdop:f(a[17])}},RMC:function(b,a){if(13!==a.length&&14!==a.length)throw"Invalid RMC length: "+b;var c=l(a[1],a[9]),d=p(a[2]),e=a[10],g=a[11];return{time:c,status:d,lat:k(a[3],a[4]),lon:k(a[5],a[6]),speed:n(a[7]),heading:f(a[8]),variation:""===e||""===g?null:parseFloat(e)*("W"===g?-1:1),faa:14===a.length?q(a[12]):null}},VTG:function(b,a){if(10!==a.length&&11!==a.length)throw"Invalid VTG length: "+
b;if(""===a[2]&&""===a[8]&&""===a[6])return{heading:null,speed:null,faa:null};if("T"!==a[2])throw"Invalid VTG track mode: "+b;if("K"!==a[8]||"N"!==a[6])throw"Invalid VTG speed tag: "+b;return{heading:f(a[1]),speed:n(a[5]),faa:11===a.length?q(a[9]):null}},GSV:function(b,a){if(9>a.length||1!==a.length%4)throw"Invalid GSV length: "+b;for(var c=[],d=4;d<a.length-1;d+=4){var e=f(a[d]),g=f(a[d+3]);c.push({prn:e,elevation:f(a[d+1]),azimuth:f(a[d+2]),snr:g,status:null!==e?null!==g?"tracking":"in view":null})}return{msgNumber:f(a[2]),
msgsTotal:f(a[1]),satellites:c}},GLL:function(b,a){if(9!==a.length)throw"Invalid GLL length: "+b;return{time:l(a[5]),status:p(a[6]),lat:k(a[1],a[2]),lon:k(a[3],a[4])}},ZDA:function(b,a){return{time:l(a[1],a[2]+a[3]+a[4])}}};g.Parse=function(b){if("string"!==typeof b)return!1;var a=b.split(","),c=a.pop();if(4>a.length||"$"!==b.charAt(0)||-1===c.indexOf("*"))return!1;c=c.split("*");a.push(c[0]);a.push(c[1]);a[0]=a[0].slice(3);if(void 0!==g.mod[a[0]]){c=this.mod[a[0]](b,a);c.raw=b;for(var d=0,e=1;e<
b.length;e++){var f=b.charCodeAt(e);if(42===f)break;d^=f}c.valid=d===parseInt(a[a.length-1],16);c.type=a[0];return c}return!1};g.Heading=function(b,a,c,d){a=(d-a)*h;b*=h;c*=h;return(Math.atan2(Math.sin(a)*Math.cos(c),Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(a))*v+360)%360};g.Distance=function(b,a,c,d){var e=(c-b)*h*.5;a=(d-a)*h*.5;b*=h;c*=h;e=Math.sin(e);a=Math.sin(a);return 12745.6*Math.asin(Math.sqrt(e*e+Math.cos(b)*Math.cos(c)*a*a))};g.prototype.update=function(b){b=g.Parse(b);
if(!1===b)return!1;var a=this.state;if(!("RMC"===b.type&&"A"!==b.status||"GGA"===b.type&&null===b.quality)){if("RMC"===b.type||"GGA"===b.type||"GLL"===b.type)a.time=b.time,a.lat=b.lat,a.lon=b.lon,a.lastFix=Date.now();"ZDA"===b.type&&(a.time=b.time);"GGA"===b.type&&(a.alt=b.alt,a.hdop=b.hdop);"RMC"===b.type&&(a.speed=b.speed,a.heading=b.heading);"GSA"===b.type&&(a.satsActive=b.satellites,a.fix=b.fix,a.hdop=b.hdop,a.pdop=b.pdop,a.vdop=b.vdop);if("GSV"===b.type){for(var c=b.satellites,d=0;d<c.length;d++)m.push(c[d]);
b.msgNumber===b.msgsTotal&&(a.satsVisible=m,m=[])}}void 0!==this.events.data&&this.events.data.call(this,b);void 0!==this.events[b.type]&&this.events[b.type].call(this,b);return!0};g.prototype.partial="";g.prototype.updatePartial=function(b){for(this.partial+=b;;){b=this.partial.indexOf("\r\n");if(-1===b)break;var a=this.partial.slice(0,b);"$"===a.charAt(0)&&this.update(a);this.partial=this.partial.slice(b+2)}};g.prototype.on=function(b,a){return void 0===this.events[b]?(this.events[b]=a,this):null};
g.prototype.off=function(b){void 0!==this.events[b]&&(this.events[b]=void 0);return this};"object"===typeof exports?module.a=g:t.GPS=g})(this);